<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

  <script src=
  "https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  <script src="../htex-ress/clipboard.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href=
  "../htex-ress/basic-screen.css" />
  <link rel="stylesheet" type="text/css" media="printer" href=
  "../htex-ress/basic-printer.css" />
  <meta http-equiv="Content-Type" content=
  "text/html; charset=us-ascii" />
  <title>TP 8 : Les fonctions d'&#233;criture du SGF</title>
  <link rel="stylesheet" type="text/css" href=
  "../blue40.screen.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../blue40.print.css"
  media="print" />
</head>
<body>
  <div id="allPage">
    <div id="header">
      <span class="header-item" id="header-accueil"><a href=
      "../index.html">Accueil</a></span><span class="header-item"
      id="m26-java"><a href="../jee/index.html">Architecture
      JEE</a></span><span class="header-item"><a href=
      "../arch-app/index.html">Architecture des
      applications</a></span><span class="header-item" id=
      "m27-xml"><a href=
      "../xml/index.html">XML</a></span><span class="header-item"
      id="info13"><a href="../systeme/index.html">Syst&#232;me
      d'exploitation</a></span><span class="header-item" id=
      "header-docs"><a href=
      "../docs/index.html">Docs</a></span><span class="header-item"
      id="xdosicalu"><a href=
      "../dosicalu/index.html">DOSICALU</a></span><span class=
      "header-item" id="header-dil"><a href=
      "http://dii.univ-mrs.fr">D&#233;partement
      d'informatique</a></span><a href="../chercher.html" id=
      "header-search" name="header-search"></a>
    </div>
    <div id="leftFrame">
      <div id="menu">
        <a class="menu1 menu-normal" href=
        "index.html"><span>Accueil</span></a><a class=
        "menu1 menu-normal" href="#"><span>Sujets de
        TPs&#160;:</span></a><a class="menu2 menu-normal" href=
        "tp01-simul1.html"><span>1. CPU et
        multi-t&#226;ches</span></a><a class="menu2 menu-normal"
        href="tp02-simul2.html"><span>2.
        Entr&#233;es/sorties</span></a><a class="menu2 menu-normal"
        href="tp03-thread.html"><span>3. Threads &amp;
        s&#233;maphores</span></a><a class="menu2 menu-normal"
        href="tp04-philo.html"><span>4. Condition de
        synchronisation</span></a><a class="menu2 menu-normal"
        href="tp05-mem.html"><span>5. Gestion
        m&#233;moire</span></a><a class="menu2 menu-normal" href=
        "tp06-ipc.html"><span>6. Les IPC UNIX</span></a><a class=
        "menu2 menu-normal" href="tp07-sgf.html"><span>7. Un mini
        SGF (1/2)</span></a><a class="menu2 menu-active" href=
        "tp08-sgf.html"><span>8. Un mini SGF
        (2/2)</span></a><a class="menu1 menu-normal" href=
        "#"><span>Liens&#160;:</span></a><a class=
        "menu2 menu-normal" href=
        "https://formations.univ-amu.fr/ME3SIN-PRSIN3AA.html"><span>&gt;&#160;Licence
        d'Info.</span></a><a class="menu2 menu-normal" href=
        "http://ametice.univ-amu.fr/course/view.php?id=30983"><span>&gt;&#160;AMETICE</span></a>
      </div>
      <div id="printable">
        <a href="tp08-sgf.pdf">Version PDF</a>
      </div>
    </div>
    <div id="content">
      <h1 id="idhtex-h1-1">TP 8 : Les fonctions d'&#233;criture du
      SGF</h1>
      <div id="table-of-contents">
        <div class="table-of-contents-title">
          &#160;Sommaire
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#idhtex-h2-1">&#201;crire
          caract&#232;re apr&#232;s caract&#232;re</a>
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#idhtex-h2-2">Ouvrir un fichier en
          mode ajout</a>
        </div>
      </div>
      <blockquote>
        <div>
          <span class="htex-DANGER">Les TP 7 et 8 sont &#224;
          rendre<br clear="none" />
          ensemble sur <a target="_blank" href=
          "http://ametice.univ-amu.fr/course/view.php?id=30983"
          shape="rect">AMETICE</a> avant le 21
          d&#233;cembre.</span>
        </div>
      </blockquote>
      <h2 id="idhtex-h2-1">&#201;crire caract&#232;re apr&#232;s
      caract&#232;re</h2>
      <p>Le principe est le m&#234;me que pour la lecture. Les
      caract&#232;res sont plac&#233;s dans le <span class=
      "htex-ttt">buffer</span> tant que celui-ci n'est pas plein.
      Une fois le <span class="htex-ttt">buffer</span>
      compl&#233;t&#233;, un nouveau bloc est ajout&#233; au
      fichier. Pour re-programmer les fonctions d'&#233;criture,
      suivez les &#233;tapes ci-dessous&#160;:</p>
      <ol type="1">
        <li>Re-programmez la fonction <span class=
        "htex-ttt">sgf_putc</span> du fichier <span class=
        "htex-ttt">sgf-io.c</span> et tester son bon fonctionnement
        avec le code ci-dessous.
          <div>
            <div class="htex-code htex-copy prettyprint lang-c">
              <div class="htex-copy-button">
                <button class="htex-copy-button"
                data-clipboard-target="#idm89" type=
                "submit"><img width="16" alt="" src=
                "../htex-ress/clippy.svg" /></button>
              </div>
              <pre xml:space="preserve" id="idm89" class=
              "htex-code htex-copy prettyprint lang-c">
OFILE* file = sgf_open_write("essai.txt", WRITE_MODE);
sgf_puts(file, "Ceci est un petit texte qui occupe\n");
sgf_puts(file, "quelques blocs sur ce disque fictif.\n");
sgf_puts(file, "Le bloc faisant 128 octets, il faut\n");
sgf_puts(file, "que je remplisse pour utiliser\n");
sgf_puts(file, "plusieurs blocs.\n");
sgf_close(file);
</pre>
            </div>
          </div>
        </li>
        <li>Programmez la fonction <span class=
        "htex-ttt">sgf_append_block</span> et testez de nouveau
        l'&#233;criture.</li>
        <li>Programmez la fonction <span class=
        "htex-ttt">sgf_close</span> et assurez vous que vous ne
        perdez pas les derniers caract&#232;res du fichier.</li>
        <li>Terminez par la fonction de destruction <span class=
        "htex-ttt">sgf_remove</span>. Faites en sorte que cette
        fonction imprime l'&#233;tat du disque (nombre de blocs
        libres par exemple). Vous devez notamment v&#233;rifier
        qu'il n'y a pas de fuite m&#233;moire (le nombre de bloc
        libres ne cesse de diminuer).</li>
      </ol>
      <h2 id="idhtex-h2-2">Ouvrir un fichier en mode ajout</h2>
      <p>On vous demande de mettre en place un mode d'ouverture en
      ajout que ne vide pas le fichier mais qui permet de
      l'agrandir. Suivez les &#233;tapes ci-dessous:</p>
      <ol type="1">
        <li>Modifiez le fichier <span class=
        "htex-ttt">sgf-header.h</span> pour enrichir la
        d&#233;claration suivante
          <div>
            <div class="htex-code htex-copy prettyprint lang-c">
              <div class="htex-copy-button">
                <button class="htex-copy-button"
                data-clipboard-target="#idm110" type=
                "submit"><img width="16" alt="" src=
                "../htex-ress/clippy.svg" /></button>
              </div>
              <pre xml:space="preserve" id="idm110" class=
              "htex-code htex-copy prettyprint lang-c">
typedef enum {
    READ_MODE,         /* Fichier ouvert en lecture         */
    WRITE_MODE,        /* Fichier ouvert en &#233;criture        */
    APPEND_MODE,       /* Fichier en mode ajout             */
} MODE;
</pre>
            </div>
          </div>
        </li>
        <li>Commencez par <span class="htex-IMP">recopier</span> la
        fonction <span class="htex-ttt">sgf_open_read</span> pour
        cr&#233;er <span class="htex-ttt">sgf_open_append</span>.
        Cette derni&#232;re doit maintenant lire le dernier bloc du
        fichier si la taille n'est pas un multiple de la taille des
        blocs. (il faut lire le dernier bloc incomplet pour le
        compl&#233;ter).</li>
        <li><span class="htex-IMP">Attention</span>&#160;: la
        fonction <span class="htex-ttt">sgf_append_block</span>
        doit maintenant &#234;tre modifi&#233;e. En mode ajout, il
        ne faut pas ajouter un nouveau bloc mais simplement
        r&#233;crire la <span class="htex-IMP">nouvelle version du
        dernier bloc</span>. Une fois cette op&#233;ration
        r&#233;alis&#233;e, <span class="htex-IMP">nous ne sommes
        plus en mode ajout</span>.</li>
        <li>Testez ce mode en vidant un fichier (ouverture en
        &#233;criture) puis en l'ouvrant 300 fois en mode ajout
        afin, &#224; chaque fois, d'ajouter un seul
        caract&#232;re.</li>
      </ol>
    </div>
  </div>
  <script src="../htex-ress/init.js"></script>
</body>
</html>
