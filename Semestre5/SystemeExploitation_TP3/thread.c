#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <stdbool.h>
#include <unistd.h>
#include <semaphore.h>

volatile int theChar;
//volatile enum {READ,WRITE} job = READ;
sem_t NPlein;
sem_t NVide;

#define BUFFER_SIZE (10)
char buffer[BUFFER_SIZE];
int ptr_input = 0;
int ptr_output = 0;

/*************************************************************
** Producteur: Lire l'entrée standard et, pour chaque
** caractère, donner le tour au consommateur.
**************************************************************/
void* read_stdin (void* argument) {
    do {
        //while (job != READ) {     /* attendre mon tour */
            //usleep(100);
        //}
        sem_wait(&NVide);
          theChar = getchar();
          buffer[ptr_input] = theChar;
          ptr_input++;
        sem_post(&NPlein);
        //job = WRITE;              /* donner le tour */
    } while (theChar != EOF);     /* Ctrl-D sur une ligne vide */

    return NULL;
}


/*************************************************************
** Consommateur: Attendre son tour et, pour chaque caractère,
** l'afficher et donner le tour au producteur.
**************************************************************/
void* write_to_stdout (void* name) {
    unsigned long cpt = 0;
    while (true) {
        //while (job != WRITE) {         /* attendre */
        sem_wait(&NPlein);
            cpt ++;
            usleep(100);
            printf("cpt=%lu, %s\n", cpt, buffer);
            //buffer[ptr_output] = '\0';
            ptr_output++;
        sem_post(&NVide);
        break;
        //}
        //if (theChar == EOF) break;

        //printf("cpt=%lu, car=%c\n", cpt, theChar);
        //job = READ;                    /* donner le tour */
    }
    return NULL;
}


/*************************************************************
** Créer les threads et attendre leurs terminaisons.
**************************************************************/
int main (void) {
    pthread_t read_thread, write_thread;
    sem_init(&NPlein, 0, 0);
    sem_init(&NVide, 0, BUFFER_SIZE);

    if (pthread_create(&read_thread, NULL, write_to_stdout, NULL)) {
        perror("pthread_create");
        exit(EXIT_FAILURE);
    }
    if (pthread_create(&write_thread, NULL, read_stdin, NULL)) {
        perror("pthread_create");
        exit(EXIT_FAILURE);
    }

    if (pthread_join(read_thread, NULL)) {
        perror("pthread_join");
        exit(EXIT_FAILURE);
    }

    if (pthread_join(write_thread, NULL)) {
        perror("pthread_join");
        exit(EXIT_FAILURE);
    }

    printf("Fin du pere\n") ;
    return (EXIT_SUCCESS);
}
