<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

  <script src=
  "https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  <script src="../htex-ress/clipboard.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href=
  "../htex-ress/basic-screen.css" />
  <link rel="stylesheet" type="text/css" media="printer" href=
  "../htex-ress/basic-printer.css" />
  <meta http-equiv="Content-Type" content=
  "text/html; charset=us-ascii" />
  <title>TP6&#160;: Utilisation des IPC Unix</title>
  <link rel="stylesheet" type="text/css" href=
  "../blue40.screen.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../blue40.print.css"
  media="print" />
</head>
<body>
  <div id="allPage">
    <div id="header">
      <span class="header-item" id="header-accueil"><a href=
      "../index.html">Accueil</a></span><span class="header-item"
      id="m26-java"><a href="../jee/index.html">Architecture
      JEE</a></span><span class="header-item"><a href=
      "../arch-app/index.html">Architecture des
      applications</a></span><span class="header-item" id=
      "m27-xml"><a href=
      "../xml/index.html">XML</a></span><span class="header-item"
      id="info13"><a href="../systeme/index.html">Syst&#232;me
      d'exploitation</a></span><span class="header-item" id=
      "header-docs"><a href=
      "../docs/index.html">Docs</a></span><span class="header-item"
      id="xdosicalu"><a href=
      "../dosicalu/index.html">DOSICALU</a></span><span class=
      "header-item" id="header-dil"><a href=
      "http://dii.univ-mrs.fr">D&#233;partement
      d'informatique</a></span><a href="../chercher.html" id=
      "header-search" name="header-search"></a>
    </div>
    <div id="leftFrame">
      <div id="menu">
        <a class="menu1 menu-normal" href=
        "index.html"><span>Accueil</span></a><a class=
        "menu1 menu-normal" href="#"><span>Sujets de
        TPs&#160;:</span></a><a class="menu2 menu-normal" href=
        "tp01-simul1.html"><span>1. CPU et
        multi-t&#226;ches</span></a><a class="menu2 menu-normal"
        href="tp02-simul2.html"><span>2.
        Entr&#233;es/sorties</span></a><a class="menu2 menu-normal"
        href="tp03-thread.html"><span>3. Threads &amp;
        s&#233;maphores</span></a><a class="menu2 menu-normal"
        href="tp04-philo.html"><span>4. Condition de
        synchronisation</span></a><a class="menu2 menu-normal"
        href="tp05-mem.html"><span>5. Gestion
        m&#233;moire</span></a><a class="menu2 menu-active" href=
        "tp06-ipc.html"><span>6. Les IPC UNIX</span></a><a class=
        "menu2 menu-normal" href="tp07-sgf.html"><span>7. Un mini
        SGF (1/2)</span></a><a class="menu2 menu-normal" href=
        "tp08-sgf.html"><span>8. Un mini SGF
        (2/2)</span></a><a class="menu1 menu-normal" href=
        "#"><span>Liens&#160;:</span></a><a class=
        "menu2 menu-normal" href=
        "https://formations.univ-amu.fr/ME3SIN-PRSIN3AA.html"><span>&gt;&#160;Licence
        d'Info.</span></a><a class="menu2 menu-normal" href=
        "http://ametice.univ-amu.fr/course/view.php?id=30983"><span>&gt;&#160;AMETICE</span></a>
      </div>
      <div id="printable">
        <a href="tp06-ipc.pdf">Version PDF</a>
      </div>
    </div>
    <div id="content">
      <h1 id="idhtex-h1-1">TP6&#160;: Utilisation des IPC Unix</h1>
      <div id="table-of-contents">
        <div class="table-of-contents-title">
          &#160;Sommaire
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#ipc-mem-share">Partage de zone
          m&#233;moire</a>
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#ipc-msg">Les s&#233;maphores &#224;
          messages</a>
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#mmap">Montage de fichiers en
          m&#233;moire</a>
        </div>
      </div>
      <h2 id="ipc-mem-share">Partage de zone m&#233;moire</h2>
      <p>Commencez par lire <a href="../docs/IPC.html" shape=
      "rect">cette documentation sur les IPC Unix</a> et
      ex&#233;cutez l'exemple propos&#233; (pour les m&#233;moires
      partag&#233;es). Nous allons utiliser la m&#233;moire
      partag&#233;e IPC pour inplanter un petit exemple de
      producteur/consommateur. La zone partag&#233;e pourrait
      &#234;tre du type suivant&#160;:</p>
      <div>
        <div class="htex-code htex-copy prettyprint lang-c">
          <div class="htex-copy-button">
            <button class="htex-copy-button" data-clipboard-target=
            "#idm77" type="submit"><img width="16" alt="" src=
            "../htex-ress/clippy.svg" /></button>
          </div>
          <pre xml:space="preserve" id="idm77" class=
          "htex-code htex-copy prettyprint lang-c">
struct {
    int the_char;        /* '\0' si vide           */
    int end;             /* signal de fin d'entr&#233;e */
} ...
</pre>
        </div>
      </div>
      <p>Le consommateur peut consommer si, et seulement si
      <span class="htex-ttt">(the_char != 0)</span>. Le producteur
      peut produire ssi <span class="htex-ttt">(the_char ==
      0)</span>. Je vous propose de suivre les &#233;tapes
      ci-dessous&#160;:</p>
      <ol type="1">
        <li>Le producteur et le consommateur sont des processus
        diff&#233;rents et des <span class=
        "htex-IMP">programmes</span> diff&#233;rents. Le producteur
        lit des caract&#232;res au clavier et les place dans le
        tampon. Le consommateur les r&#233;cup&#232;re et les
        affiche. Ces deux acteurs appliquent la m&#233;thode de
        l'attente active pour se synchroniser.</li>
        <li>Faites en sorte que la zone partag&#233;e soit
        cr&#233;&#233;e et initialis&#233;e par le producteur. Si
        le consommateur est plus rapide, il doit attendre que la
        zone partag&#233;e soit disponible.</li>
        <li>Prenez soin de ralentir le producteur et le
        consommateur pour tester tous les cas de figure.</li>
        <li>La fin de la lecture au clavier est indiqu&#233;e au
        consommateur par la mise &#224; un du drapeau <span class=
        "htex-ttt">end</span>. Ce dernier a la charge de supprimer
        la ressource partag&#233;e avant de se terminer.</li>
        <li>Consultez la carte m&#233;moire de ces processus.</li>
      </ol>
      <h2 id="ipc-msg">Les s&#233;maphores &#224; messages</h2>
      <p>Refaites le m&#234;me exercice mais en rempla&#231;ant la
      m&#233;moire partag&#233;e par un envoi de message entre le
      producteur et le consommateur.</p>
      <h2 id="mmap">Montage de fichiers en m&#233;moire</h2>
      <p>La fonction <span class="htex-ttt">mmap</span> permet de
      projeter un fichier en m&#233;moire (plus de pr&#233;cisions
      avec <span class="htex-ttt">man&#160;mmap</span>). Voila un
      petit exemple&#160;:</p>
      <div>
        <div class="htex-code htex-copy prettyprint lang-c">
          <div class="htex-copy-button">
            <button class="htex-copy-button" data-clipboard-target=
            "#idm108" type="submit"><img width="16" alt="" src=
            "../htex-ress/clippy.svg" /></button>
          </div>
          <pre xml:space="preserve" id="idm108" class=
          "htex-code htex-copy prettyprint lang-c">
#include &lt;sys/types.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;fcntl.h&gt;

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;


void create_file(int size) {
    FILE *f = fopen("data", "w");
    int i;

    for(i=1; i&lt;size; i++) {
        fputc('A', f);
    }
    fputc('\n', f);
    fclose(f);
}


int main() {
    int file;
    char* zone;
    int size = 60;
    int i;

    /* cr&#233;ation du fichier pour l'exemple */
    create_file(size);

    /* ouverture en utilisant les fonctions UNIX */
    file = open("data", O_RDWR, 0700);
    if (file &lt; 0) {
        perror("open");
        return (EXIT_FAILURE);
    }

    /* montage en m&#233;moire */
    zone = mmap(NULL, size, PROT_READ|PROT_WRITE, MAP_SHARED, file, 0);
    if (zone == NULL) {
        perror("mmap");
        return (EXIT_FAILURE);
    }
    
    /* utilisation */
    printf("Affichage du contenu\n");
    for(i=0; (i&lt;size); i++) {
        putchar(zone[i]);
    }

    return (EXIT_SUCCESS);
}
</pre>
        </div>
      </div>
      <p><span class="htex-IMP">Travail &#224;
      faire</span>&#160;:</p>
      <ul>
        <li>Ex&#233;cutez l'exemple et &#233;tudiez son
        fonctionnement.</li>
        <li>Modifiez un des caract&#232;res en v&#233;rifiant la
        mise &#224; jour automatique du fichier sur disque.</li>
        <li>Alors que votre processus a d&#233;j&#224; projet&#233;
        le fichier (freinez le avec un <span class=
        "htex-ttt">getchar</span>), modifiez le fichier d'origine
        (avec un &#233;diteur de texte) et v&#233;rifiez que la
        modification est bien report&#233;e dans la version
        projet&#233;e.</li>
        <li>Consultez la carte m&#233;moire de ce processus.</li>
      </ul>
    </div>
  </div>
  <script src="../htex-ress/init.js"></script>
</body>
</html>
