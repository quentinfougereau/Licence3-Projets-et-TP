<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

  <script src=
  "https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  <script src="../htex-ress/clipboard.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href=
  "../htex-ress/basic-screen.css" />
  <link rel="stylesheet" type="text/css" media="printer" href=
  "../htex-ress/basic-printer.css" />
  <meta http-equiv="Content-Type" content=
  "text/html; charset=us-ascii" />
  <title>TP4&#160;: Les conditions de synchronisation</title>
  <link rel="stylesheet" type="text/css" href=
  "../blue40.screen.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../blue40.print.css"
  media="print" />
</head>
<body>
  <div id="allPage">
    <div id="header">
      <span class="header-item" id="header-accueil"><a href=
      "../index.html">Accueil</a></span><span class="header-item"
      id="m26-java"><a href="../jee/index.html">Architecture
      JEE</a></span><span class="header-item"><a href=
      "../arch-app/index.html">Architecture des
      applications</a></span><span class="header-item" id=
      "m27-xml"><a href=
      "../xml/index.html">XML</a></span><span class="header-item"
      id="info13"><a href="../systeme/index.html">Syst&#232;me
      d'exploitation</a></span><span class="header-item" id=
      "header-docs"><a href=
      "../docs/index.html">Docs</a></span><span class="header-item"
      id="xdosicalu"><a href=
      "../dosicalu/index.html">DOSICALU</a></span><span class=
      "header-item" id="header-dil"><a href=
      "http://dii.univ-mrs.fr">D&#233;partement
      d'informatique</a></span><a href="../chercher.html" id=
      "header-search" name="header-search"></a>
    </div>
    <div id="leftFrame">
      <div id="menu">
        <a class="menu1 menu-normal" href=
        "index.html"><span>Accueil</span></a><a class=
        "menu1 menu-normal" href="#"><span>Sujets de
        TPs&#160;:</span></a><a class="menu2 menu-normal" href=
        "tp01-simul1.html"><span>1. CPU et
        multi-t&#226;ches</span></a><a class="menu2 menu-normal"
        href="tp02-simul2.html"><span>2.
        Entr&#233;es/sorties</span></a><a class="menu2 menu-normal"
        href="tp03-thread.html"><span>3. Threads &amp;
        s&#233;maphores</span></a><a class="menu2 menu-active"
        href="tp04-philo.html"><span>4. Condition de
        synchronisation</span></a><a class="menu2 menu-normal"
        href="tp05-mem.html"><span>5. Gestion
        m&#233;moire</span></a><a class="menu2 menu-normal" href=
        "tp06-ipc.html"><span>6. Les IPC UNIX</span></a><a class=
        "menu2 menu-normal" href="tp07-sgf.html"><span>7. Un mini
        SGF (1/2)</span></a><a class="menu2 menu-normal" href=
        "tp08-sgf.html"><span>8. Un mini SGF
        (2/2)</span></a><a class="menu1 menu-normal" href=
        "#"><span>Liens&#160;:</span></a><a class=
        "menu2 menu-normal" href=
        "https://formations.univ-amu.fr/ME3SIN-PRSIN3AA.html"><span>&gt;&#160;Licence
        d'Info.</span></a><a class="menu2 menu-normal" href=
        "http://ametice.univ-amu.fr/course/view.php?id=30983"><span>&gt;&#160;AMETICE</span></a>
      </div>
      <div id="printable">
        <a href="tp04-philo.pdf">Version PDF</a>
      </div>
    </div>
    <div id="content">
      <h1 id="idhtex-h1-1">TP4&#160;: Les conditions de
      synchronisation</h1>
      <div id="table-of-contents">
        <div class="table-of-contents-title">
          &#160;Sommaire
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#cond-synchro">Les conditions de
          synchronisation</a>
        </div>
        <div class="table-of-contents-level2">
          &gt;&#160;<a href="#idhtex-h3-1">Pr&#233;sentation</a>
        </div>
        <div class="table-of-contents-level2">
          &gt;&#160;<a href="#idhtex-h3-2">Un exemple</a>
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#idhtex-h2-2">Les philosophes et les
          spaghettis</a>
        </div>
        <div class="table-of-contents-level2">
          &gt;&#160;<a href="#idhtex-h3-3">Pr&#233;sentation</a>
        </div>
        <div class="table-of-contents-level2">
          &gt;&#160;<a href="#idhtex-h3-4">Comment faire ?</a>
        </div>
      </div>
      <h2 id="cond-synchro">Les conditions de synchronisation</h2>
      <h3 id="idhtex-h3-1">Pr&#233;sentation</h3>
      <p>Nous avons pr&#233;sent&#233; dans le cours les
      <span class="htex-IMP">r&#233;gions critiques</span>
      bas&#233;es sur l'attente d'une <span class=
      "htex-IMP">condition de synchronisation</span>&#160;:</p>
      <div>
        <div class="htex-code">
          <pre xml:space="preserve" id="idm80" class="htex-code">
r&#233;gion p quand (condition)
    r&#233;gion critique
fin de r&#233;gion
</pre>
        </div>
      </div>
      <p>La r&#233;gion critique est ex&#233;cut&#233;e en
      exclusion mutuelle (sur <span class="htex-ttt">p</span>) si
      la condition est respect&#233;e. Les threads Linux implantent
      cette fonction avec les <span class=
      "htex-ttt">pthread_cond</span>. Ces conditions s'utilisent
      toujours avec un verrou (<span class=
      "htex-ttt">pthread_mutex</span> ou s&#233;maphore avec un
      compteur initial valant 1).</p>
      <h3 id="idhtex-h3-2">Un exemple</h3>
      <p><span class="htex-IMP">Travail &#224;
      faire</span>&#160;:</p>
      <ul>
        <li>Commencez par lire la page de manuel des conditions de
        synchronisation (avec <span class=
        "htex-ttt">man&#160;pthread_cond_init</span>).</li>
        <li>Ex&#233;cutez ce programme et &#233;tudiez son
        fonctionnement&#160;:
          <div>
            <div class="htex-code htex-copy prettyprint lang-c">
              <div class="htex-copy-button">
                <button class="htex-copy-button"
                data-clipboard-target="#idm98" type=
                "submit"><img width="16" alt="" src=
                "../htex-ress/clippy.svg" /></button>
              </div>
              <pre xml:space="preserve" id="idm98" class=
              "htex-code htex-copy prettyprint lang-c">
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
#include &lt;unistd.h&gt;

/**********************************************************************
** Outils de synchronisation.
**********************************************************************/
pthread_mutex_t mutex     = PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t  condition = PTHREAD_COND_INITIALIZER;

/**********************************************************************
** D&#233;finition des couleurs et du nombre de peintres
**********************************************************************/
typedef enum {RED, BLUE} COLOR;
char* colors_name[] = {"RED", "BLUE"};

COLOR color = RED;
int nbPainters = 0;

/**********************************************************************
** Chaque peintre va r&#233;cup&#233;rer un num&#233;ro unique et une couleur
** et peindre trois fois en alternant les couleurs.
**********************************************************************/
void* painter (void* _unused) {
    COLOR my_color;
    int my_number;
    int i;

    /* Chaque peintre prend un num&#233;ro et une couleur. */
    pthread_mutex_lock(&amp;mutex);
    my_number = (++nbPainters);
    my_color = ((my_number % 2) ? RED : BLUE);
    pthread_mutex_unlock(&amp;mutex);

    /* il y a trois zones &#224; peindre */
    for(i=0; (i &lt; 3); i++) {
    
        /* il faut attendre pour alterner les couleurs */
        pthread_mutex_lock(&amp;mutex);
        while (color != my_color) {
            /* je m'endors car la condition est fausse */
            pthread_cond_wait(&amp;condition, &amp;mutex);
        }
        
        printf("num&#233;ro=%d, couleur=%s\n", my_number, colors_name[my_color]);
        sleep(1);
        
        /* je passe a la couleur suivante */
        color = ((color == RED) ? BLUE : RED);
        pthread_cond_broadcast(&amp;condition);
        pthread_mutex_unlock(&amp;mutex);
    }
 
    /* pas de r&#233;sultat */
    return NULL;
}

/**********************************************************************
** Initialiser les peintres et attendre la fin du travail.
**********************************************************************/

#define NB_PAINTERS  (4)

int main (void) {
    pthread_t peintres[NB_PAINTERS];
    int i;
    
    for(i=0; (i &lt; NB_PAINTERS); i++) {
        if (pthread_create(&amp;peintres[i], NULL, painter, NULL)) {
            perror("thread");
            return (EXIT_FAILURE);
        }
    }

    for(i=0; (i &lt; NB_PAINTERS); i++) {
        if (pthread_join(peintres[i], NULL)) {
            perror("pthread_join");
            return (EXIT_FAILURE);
        }
    }

    printf("Fin du pere\n") ;
    return (EXIT_SUCCESS);
}
</pre>
            </div>
          </div>
        </li>
        <li>Que se passe-t-il si le nombre de peintres est impaire
        ? Comment corriger la situation ?</li>
      </ul>
      <h2 id="idhtex-h2-2">Les philosophes et les spaghettis</h2>
      <h3 id="idhtex-h3-3">Pr&#233;sentation</h3>
      <p>Nous retrouvons dans un restaurant <span class=
      "htex-ttt">n</span> philosophes attabl&#233;s pour manger un
      plat de spaghettis. Chaque philosophe alterne des
      p&#233;riodes de ripaille et des p&#233;riodes d'intense
      r&#233;flexion. Malheureusement, le restaurateur a plac&#233;
      seulement une fourchette entre chaque philosophe soit
      <span class="htex-ttt">n</span> fourchettes et, bien entendu,
      les philosophes ont besoin de deux fourchettes pour manger.
      Ils appliquent donc l'algorithme suivant&#160;:</p>
      <div>
        <div class="htex-code">
          <pre xml:space="preserve" id="idm112" class="htex-code">
R&#233;p&#233;ter
    prendre les fourchettes de droite et de gauche
    manger
    reposer les fourchettes
    m&#233;diter sur la cuisson de spaghettis
Jusqu'&#224; ...
</pre>
        </div>
      </div>
      <p>On vous demande d'&#233;crire un programme qui simule
      l'activit&#233; des philosophes pour r&#233;gler le partage
      des fourchettes. Commencez avec deux puis 5 ou 6
      philosophes.</p>
      <h3 id="idhtex-h3-4">Comment faire ?</h3>
      <p>On vous donne les indications suivantes&#160;:</p>
      <ul>
        <li>chaque philosophe est repr&#233;sent&#233; par un
        thread (le code est le m&#234;me pour tous les
        threads),</li>
        <li>un tableau de bool&#233;ens code l'&#233;tat des
        fourchettes (prise ou libre).</li>
        <li>La condition de synchronisation est li&#233;e &#224; la
        prise des fourchettes par les philosophes. Elle est de la
        forme</li>
      </ul>
      <div>
        <div class="htex-code htex-copy prettyprint lang-c">
          <div class="htex-copy-button">
            <button class="htex-copy-button" data-clipboard-target=
            "#idm128" type="submit"><img width="16" alt="" src=
            "../htex-ress/clippy.svg" /></button>
          </div>
          <pre xml:space="preserve" id="idm128" class=
          "htex-code htex-copy prettyprint lang-c">
((fourchette[gauche] == LIBRE) &amp;&amp; (fourchette[droite] == LIBRE))
</pre>
        </div>
      </div>
      <ul>
        <li>il est <span class="htex-IMP">fortement</span>
        conseill&#233; d'imprimer un message pour signaler
        l'&#233;tat d'un philosophe, par exemple
          <div>
            <div class="htex-code">
              <pre xml:space="preserve" id="idm135" class=
              "htex-code">
le philosophe 1 prend les fourchettes
le philosophe 1 commence &#224; manger
le philosophe 1 repose les fourchettes
le philosophe 1 pense ...
etc...
</pre>
            </div>
          </div>
        </li>
      </ul>
      <p>Je vous conseille de suivre les &#233;tapes
      ci-dessous:</p>
      <ol type="1">
        <li>Le restaurateur commence par poser les fourchettes (en
        clair, commencez par initialiser le tableau, le verrou et
        la condition de synchronisation).</li>
        <li>Dans un deuxi&#232;me temps, les philosophes arrivent
        (en clair, cr&#233;ez <span class="htex-ttt">n</span>
        threads, un par philosophe).</li>
        <li>Chaque philosophe ne s'int&#233;resse qu'&#224; la
        fourchette de droite ou de gauche (en clair, calculez le
        num&#233;ro de ses fourchettes gauche et droite).</li>
        <li>Les philosophes se bloquent sur la condition de
        synchronisation pour attendre que leurs <span class=
        "htex-IMP">DEUX</span> fourchettes soient libres.</li>
        <li>Pensez &#224; donner de la lecture &#224; chaque
        philosophe (en clair, ralentissez les processus en appelant
        la fonction <span class="htex-ttt">sleep</span>).</li>
      </ol>
    </div>
  </div>
  <script src="../htex-ress/init.js"></script>
</body>
</html>
