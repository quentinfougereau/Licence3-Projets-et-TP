#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>

pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;

#define NB_PHILOSOPHES (4)

typedef enum {LIBRE, OCCUPE} ETAT;
int fourchette[NB_PHILOSOPHES];

int nbPhilosophes = 0;

void* philosophe (void* _unused) {

  int my_number;

  pthread_mutex_lock(&mutex);
  my_number = (++nbPhilosophes);
  pthread_mutex_unlock(&mutex);

  pthread_mutex_lock(&mutex);
  if (fourchette[my_number] == LIBRE && fourchette[(my_number + 1) % 5] == LIBRE) {
    fourchette[my_number] == OCCUPE;
    fourchette[(my_number + 1) % 5] == OCCUPE;
  }

  printf("Le philosophe %d prend les fourchettes\n", my_number);
  pthread_mutex_unlock(&mutex);

  sleep(1);

  pthread_mutex_lock(&mutex);
  fourchette[my_number] == LIBRE;
  fourchette[(my_number + 1) % 5] == LIBRE;
  pthread_mutex_unlock(&mutex);

  printf("Le philosophe %d pose les fourchettes\n", my_number);
  printf("Le philosophe %d pense\n", my_number);
  sleep(1);

}

int main (void) {

  pthread_t philosophes[NB_PHILOSOPHES];

  for (int i = 0; i < NB_PHILOSOPHES; i ++) {
    fourchette[i] = LIBRE;
  }

  for(int i = 0; (i < NB_PHILOSOPHES); i++) {
    if (pthread_create(&philosophes[i], NULL, philosophe, NULL)) {
        perror("thread");
        return (EXIT_FAILURE);
    }
  }

  for(int i = 0; (i < NB_PHILOSOPHES); i++) {
    if (pthread_join(philosophes[i], NULL)) {
        perror("pthread_join");
        return (EXIT_FAILURE);
    }
  }

  printf("Fin du pere\n") ;
  return (EXIT_SUCCESS);

}
