<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

  <script src=
  "https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  <script src="../htex-ress/clipboard.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href=
  "../htex-ress/basic-screen.css" />
  <link rel="stylesheet" type="text/css" media="printer" href=
  "../htex-ress/basic-printer.css" />
  <meta http-equiv="Content-Type" content=
  "text/html; charset=us-ascii" />
  <title>TP5&#160;: Gestion de la m&#233;moire dans Linux</title>
  <link rel="stylesheet" type="text/css" href=
  "../blue40.screen.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../blue40.print.css"
  media="print" />
</head>
<body>
  <div id="allPage">
    <div id="header">
      <span class="header-item" id="header-accueil"><a href=
      "../index.html">Accueil</a></span><span class="header-item"
      id="m26-java"><a href="../jee/index.html">Architecture
      JEE</a></span><span class="header-item"><a href=
      "../arch-app/index.html">Architecture des
      applications</a></span><span class="header-item" id=
      "m27-xml"><a href=
      "../xml/index.html">XML</a></span><span class="header-item"
      id="info13"><a href="../systeme/index.html">Syst&#232;me
      d'exploitation</a></span><span class="header-item" id=
      "header-docs"><a href=
      "../docs/index.html">Docs</a></span><span class="header-item"
      id="xdosicalu"><a href=
      "../dosicalu/index.html">DOSICALU</a></span><span class=
      "header-item" id="header-dil"><a href=
      "http://dii.univ-mrs.fr">D&#233;partement
      d'informatique</a></span><a href="../chercher.html" id=
      "header-search" name="header-search"></a>
    </div>
    <div id="leftFrame">
      <div id="menu">
        <a class="menu1 menu-normal" href=
        "index.html"><span>Accueil</span></a><a class=
        "menu1 menu-normal" href="#"><span>Sujets de
        TPs&#160;:</span></a><a class="menu2 menu-normal" href=
        "tp01-simul1.html"><span>1. CPU et
        multi-t&#226;ches</span></a><a class="menu2 menu-normal"
        href="tp02-simul2.html"><span>2.
        Entr&#233;es/sorties</span></a><a class="menu2 menu-normal"
        href="tp03-thread.html"><span>3. Threads &amp;
        s&#233;maphores</span></a><a class="menu2 menu-normal"
        href="tp04-philo.html"><span>4. Condition de
        synchronisation</span></a><a class="menu2 menu-active"
        href="tp05-mem.html"><span>5. Gestion
        m&#233;moire</span></a><a class="menu2 menu-normal" href=
        "tp06-ipc.html"><span>6. Les IPC UNIX</span></a><a class=
        "menu2 menu-normal" href="tp07-sgf.html"><span>7. Un mini
        SGF (1/2)</span></a><a class="menu2 menu-normal" href=
        "tp08-sgf.html"><span>8. Un mini SGF
        (2/2)</span></a><a class="menu1 menu-normal" href=
        "#"><span>Liens&#160;:</span></a><a class=
        "menu2 menu-normal" href=
        "https://formations.univ-amu.fr/ME3SIN-PRSIN3AA.html"><span>&gt;&#160;Licence
        d'Info.</span></a><a class="menu2 menu-normal" href=
        "http://ametice.univ-amu.fr/course/view.php?id=30983"><span>&gt;&#160;AMETICE</span></a>
      </div>
      <div id="printable">
        <a href="tp05-mem.pdf">Version PDF</a>
      </div>
    </div>
    <div id="content">
      <h1 id="idhtex-h1-1">TP5&#160;: Gestion de la m&#233;moire
      dans Linux</h1>
      <div id="table-of-contents">
        <div class="table-of-contents-title">
          &#160;Sommaire
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#idhtex-h2-1">La m&#233;moire logique
          des processus</a>
        </div>
        <div class="table-of-contents-level1">
          &gt;&#160;<a href="#idhtex-h2-2">Protection de la
          m&#233;moire avec UNIX</a>
        </div>
      </div>
      <h2 id="idhtex-h2-1">La m&#233;moire logique des
      processus</h2>
      <p>Le m&#233;moire logique d'un processus est constitu&#233;e
      d'un ensemble de <i>r&#233;gions</i>. Une r&#233;gion est une
      portion contigu&#235; de la m&#233;moire logique d'un
      processus. A chaque r&#233;gion le syst&#232;me associe des
      protections et un r&#244;le particulier. Le but de cet
      exercice est de visualiser et de comprendre ces r&#233;gions.
      Commencez par compiler (en mode <span class=
      "htex-ttt">-static</span>) le programme suivant&#160;:</p>
      <div>
        <div class="htex-code htex-copy prettyprint lang-c">
          <div class="htex-copy-button">
            <button class="htex-copy-button" data-clipboard-target=
            "#idm79" type="submit"><img width="16" alt="" src=
            "../htex-ress/clippy.svg" /></button>
          </div>
          <pre xml:space="preserve" id="idm79" class=
          "htex-code htex-copy prettyprint lang-c">
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;assert.h&gt;

int une_globale;
char* alloc;
const char* cst = "une-chaine";

/**************************************************
 Afficher la carte m&#233;moire du processus
 fichier /proc/self/maps
 **************************************************/
void dump_maps(void) {
    FILE *f;
    int c;
    
    f = fopen("/proc/self/maps", "r");
    assert(f != NULL);
    while ((c = fgetc(f)) != EOF) {
        putchar(c);
    }
    fclose(f);
    getchar();
}


/**************************************************
 Afficher les adresses de diff&#233;rents objets m&#233;moire
 **************************************************/
int main(int argc, char* argv[]) {
    int une_locale;
    
    alloc = malloc(1024L * 1024L * 10L); /* 10mo */
    printf("PID = %d\n", getpid());
    printf("adresse de une_globale  = %012lx\n", (unsigned long) &amp; une_globale);
    printf("adresse de une_locale   = %012lx\n", (unsigned long) &amp; une_locale);
    printf("adresse de alloc        = %012lx\n", (unsigned long)   alloc);
    printf("adresse de une_fonction = %012lx\n", (unsigned long) &amp; main);
    printf("adresse d'une constante = %012lx\n", (unsigned long)   cst);

    /* afficher la carte m&#233;moire */
    dump_maps();

    return (EXIT_SUCCESS);
}
</pre>
        </div>
      </div>
      <p>L'ex&#233;cution de ce programme provoque l'affichage d'un
      PID et d'une s&#233;rie d'adresses. Dans le syst&#232;me
      Linux, les utilisateurs sont capables d'obtenir beaucoup
      d'informations sur les processus. Ces informations se
      trouvent dans le r&#233;pertoire</p>
      <blockquote>
        <div>
          <span class=
          "htex-ttt">/proc/<i>PID_du_processus</i></span>
        </div>
      </blockquote>
      <p>On y trouve notamment le fichier <span class=
      "htex-ttt">maps</span> qui donne la liste des r&#233;gions
      associ&#233;es &#224; ce processus. Pour chaque r&#233;gion
      nous trouvons son espace adressable, les protections,
      l'offset (le d&#233;calage), le num&#233;ro du
      p&#233;riph&#233;rique (<span class=
      "htex-ttt"><i>majeur</i>:<i>mineur</i></span>) et un
      num&#233;ro de i-node. On trouve &#233;galement dans ce
      r&#233;pertoire le fichier <span class=
      "htex-ttt">statm</span> qui donne des statistiques sur
      l'utilisation de la m&#233;moire (<span class=
      "htex-ttt">man&#160;proc</span> pour avoir plus de
      pr&#233;cisions).</p>
      <p><span class="htex-IMP">Questions</span>&#160;:</p>
      <ul>
        <li>En comparant l'espace adressable de chaque r&#233;gion
        et les adresses donn&#233;es par le programme, donnez un
        sens &#224; chaque r&#233;gion (allez sur <a target=
        "_blank" href=
        "http://linux-attitude.fr/post/coup-de-fil-pour-le-noyau"
        shape="rect">ce site</a> pour avoir des informations sur
        VDSO).</li>
        <li>M&#234;me exercice mais en compilant le programme sans
        la directive <span class="htex-ttt">-static</span>.
        <span class="htex-IMP">Remarque</span>&#160;: le
        syst&#232;me UNIX associe un num&#233;ro &#224; chaque
        fichier sur disque. Ce num&#233;ro (appel&#233; le
        num&#233;ro de i-node) peut-&#234;tre visualis&#233; en
        utilisant l'option <span class="htex-ttt">-i</span> de la
        commande <span class="htex-ttt">ls</span>.</li>
        <li>Apr&#232;s le premier affichage de la carte
        m&#233;moire, ajoutez une nouvelle allocation de
        m&#233;moire dynamique et analysez la nouvelle carte
        m&#233;moire obtenue.</li>
      </ul>
      <h2 id="idhtex-h2-2">Protection de la m&#233;moire avec
      UNIX</h2>
      <p>Commencez par &#233;tudier l'appel syst&#232;me
      <span class="htex-ttt">mprotect</span>&#160;:</p>
      <div>
        <div class="htex-code prettyprint lang-sh">
          <pre xml:space="preserve" id="idm120" class=
          "htex-code prettyprint lang-sh">
man 2 mprotect
</pre>
        </div>
      </div>
      <p>Utilisez cette fonction pour prot&#233;ger une portion
      m&#233;moire d'un de vos programme. La d&#233;marche est la
      suivante&#160;:</p>
      <ol type="1">
        <li>&#201;crivez un programme qui alloue un tableau de 16
        kilo-octets (fonction <span class="htex-ttt">malloc</span>)
        et qui initialise ce tableau.</li>
        <li>Modifiez votre programme pour prot&#233;ger en
        &#233;criture (puis en lecture) une portion centrale de
        votre tableau. Quel est le r&#233;sultat&#160;? Tentez sur
        votre tableau une op&#233;ration interdite. <span class=
        "htex-IMP">Remarque</span>&#160;:
          <ul>
            <li>vous aurez surement besoin d'aligner un pointeur
            sur le d&#233;but d'une page&#160;: utiliser la
            fonction <span class="htex-ttt">sysconf</span> pour
            r&#233;cup&#233;rer la taille d'une page.</li>
            <li>Vous pouvez &#233;galement utiliser la fonction
            <span class="htex-ttt">memalign</span>.</li>
          </ul>
        </li>
        <li>Affichez la carte m&#233;moire avant la protection et
        apr&#232;s. Quel est l'effet de la protection sur les
        r&#233;gions du processus&#160;?</li>
      </ol>
    </div>
  </div>
  <script src="../htex-ress/init.js"></script>
</body>
</html>
